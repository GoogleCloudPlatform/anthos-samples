# Anthos clusters on bare metal `nettest`

Anthos clusters on bare metal `nettest` identifies connectivity issues in the Kubernetes objects in your clusters, such as Pods, Nodes, Services, and some external targets. `nettest` doesn't check connections from external targets to Pods, Nodes, or Services. This playbook describes how to deploy and run `nettest` with the supplied manifests, [`nettest.yaml`](https://github.com/GoogleCloudPlatform/anthos-samples/blob/main/anthos-bm-utils/abm-nettest/nettest.yaml) and [`nettest_rhel.yaml`](https://github.com/GoogleCloudPlatform/anthos-samples/blob/main/anthos-bm-utils/abm-nettest/nettest_rhel.yaml). The playbook includes information to help you interpret the logs generated by `nettest`.  The playbook has instructions for removing `nettest` when you are finished.

`nettest` manifest consists of

  * `cloudprober` - A DaemonSet and A Service responsible for collecting network connection status, such as error rate and latency.
  * `echoserver` - A DaemonSet and A Service responsible for responding to `cloudprober`.
  * `nettest` - A Pod containing `prometheus` and `nettest` container. `prometheus` collects metrics from `cloudprober`, and `nettest` queries `prometheus` and display the network test results in the log.
  * `nettest-engine` - A Configmap to configure `nettest` container in `nettest` Pod.

It also includes `nettest` namespace, ServiceAccount (along with ClusterRole and ClusterRoleBinding) to achieve separation from other namespaces.

## Run `nettest`

Deploy `nettest` by running the following command for your operating system. Upon `nettest` Pod is started, the test will run automatically. Note that `nettest` take about 5 minutes and it will keep running even after it detects any connection issues.

For non-RHEL OS:

```
kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/anthos-samples/main/anthos-bm-utils/abm-nettest/nettest.yaml
```

For RHEL OS:

```
kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/anthos-samples/main/anthos-bm-utils/abm-nettest/nettest_rhel.yaml
```

Note: If you use a private registry, you need to download the manifest and edit the image names to work with your local registry mirror.

## Get the test result

Run the following command to see the `nettest` result:

```
kubectl -n nettest logs nettest -c nettest
```

While the nettest is running, you will see messages like the following:

```
I0413 03:33:04.879141       1 collectorui.go:130] Listening on ":8999"
I0413 03:33:04.879258       1 prometheus.go:172] Running prometheus controller
E0413 03:33:04.879628       1 prometheus.go:178] Prometheus controller: failed to retries probers: Get "http://127.0.0.1:9090/api/v1/targets": dial tcp 127.0.0.1:9090: connect: connection refused
```

NOTE: the `connection refused` message is expected. You will see the result in 5 minutes.

If `nettest` runs successfully without identifying any connectivity failures, you see the following log entry:

```
I0211 21:58:34.689290       1 validate_metrics.go:78] Metric validation passed!
```

If the nettest failed (found some connection issues), you will see the following logs:

```
E0211 06:40:11.948634       1 collector.go:65] Engine error: step validateMetrics failed:
"Error rate in percentage": probe from "10.200.0.3" to "172.26.115.210:80" has value 100.000000, threshold is 1.000000
"Error rate in percentage": probe from "10.200.0.3" to "172.26.27.229:80" has value 100.000000, threshold is 1.000000
"Error rate in percentage": probe from "192.168.3.248" to "echoserver-hostnetwork_10.200.0.2_8080" has value 2.007046, threshold is 1.000000
```

When the issue has been addressed, you can remove the `nettest` pod and reapply the same manifest:

for non-RHEL OS (for example):

```
kubectl -n nettest delete pod nettest
kubectl apply -f https://raw.githubusercontent.com/GoogleCloudPlatform/anthos-samples/main/anthos-bm-utils/abm-nettest/nettest.yaml
```

## Cleanup

NOTE: cleaning up will remove all existing logs.

After tests are finished, we can cleanup the artifacts via running:

```
kubectl delete namespace nettest
kubectl delete clusterroles nettest:nettest
kubectl delete clusterrolebindings nettest:nettest
```

# Appendix

## How to interpret nettest logs

When `nettest` finishes and finds a connectivity issue, you see the following entry in the `nettest` Pod logs:

```
"Error rate in percentage": probe from {src} to {dst} has value 100.000000, threshold is 1.000000
```

Here, `{src}` and `{dst}` can be either:

*  `echoserver` Pod IP (the connection to/from a pod on the node)
*   Node IP (the connection to/from the node)
*   Service IP (see the following text for details)

In addition, `{dst}` can also be:

*   google.com (the connection to external)
*   dns (the connection to non-hostnetwork service through dns, that is `echoserver-non-hostnetwork.nettest.svc.cluster.local`)

The details for service IP are found in JSON-formatted probe entries in the log, like the following example. In the following probe example, you can see that `172.26.27.229:80` is the address for `service-clusterip`. There are two probes with this `targets` value, one for the pod (`pod-service-clusterip`) and one for the VM (`vm-service-clusterip`).

```
probe {
  name: "vm-service-clusterip"
  â€¦
  targets {
    host_names: "172.26.27.229:80"
  }
```
